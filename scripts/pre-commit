#!/bin/bash
#
# AMPEL360 Space-T Pre-commit Hook
# Validates filenames against nomenclature standard
#
# Installation:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Validating nomenclature standard..."

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úì No files to validate${NC}"
    exit 0
fi

# Validate each staged file
INVALID_COUNT=0

for file in $STAGED_FILES; do
    # Skip directories
    if [ -d "$file" ]; then
        continue
    fi
    
    # Extract filename from path
    filename=$(basename "$file")
    
    # Skip excluded files
    if [[ "$filename" =~ ^(README\.md|LICENSE|EXAMPLES\.md|STRUCTURE_SUMMARY\.md|\.gitignore|\.gitattributes)$ ]]; then
        continue
    fi
    
    # Skip files in excluded directories
    if [[ "$file" =~ ^\.(git|github)/ ]] || [[ "$file" =~ ^(node_modules|__pycache__|\.pytest_cache|\.venv|venv|dist|build)/ ]]; then
        continue
    fi
    
    # Validate filename and capture output
    validation_output=$(python validate_nomenclature.py "$filename" 2>&1 || true)
    if [ $? -ne 0 ]; then
        echo -e "${RED}‚úó Invalid: $filename${NC}"
        echo "$validation_output"
        INVALID_COUNT=$((INVALID_COUNT + 1))
    fi
done

if [ $INVALID_COUNT -gt 0 ]; then
    echo ""
    echo -e "${RED}‚ùå Commit blocked: $INVALID_COUNT file(s) violate nomenclature standard${NC}"
    echo ""
    echo "Please rename files to follow the pattern:"
    echo "[ROOT]_[BUCKET]_[TYPE]_[VARIANT]_[DESCRIPTION]_[VERSION].[EXT]"
    echo ""
    echo "See 00_00_STD_LC01-Q100BL_nomenclature-standard_v01.md for details"
    echo "Or run: python validate_nomenclature.py --help"
    exit 1
fi

echo -e "${GREEN}‚úì All staged files comply with nomenclature standard${NC}"
exit 0
