name: Governance Gates (Comprehensive)

on:
  pull_request:
    branches: ['main', 'develop']
  workflow_dispatch:

jobs:
  governance-checks:
    runs-on: ubuntu-latest
    name: CI Governance Gates
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      # GATE-001: Nomenclature Validation (BLOCKING)
      - name: GATE-001 - Nomenclature Validation
        id: nomenclature
        run: |
          echo "üîç Running nomenclature validation..."
          python validate_nomenclature.py --check-all --strict --verbose
        continue-on-error: false
      
      # GATE-005: Identifier Grammar Check (BLOCKING - when script exists)
      - name: GATE-005 - Identifier Grammar Check
        id: identifier
        run: |
          echo "üîç Checking identifier grammar..."
          if [ -f "scripts/validate_identifiers.py" ]; then
            python scripts/validate_identifiers.py --all
          else
            echo "‚ö†Ô∏è  Script not yet implemented (planned)"
          fi
        continue-on-error: true
      
      # GATE-002: Schema Registration Check (BLOCKING)
      - name: GATE-002 - Schema Registration Check
        id: schema_registration
        run: |
          echo "üîç Checking schema registration..."
          set +e  # Don't exit on error, we need to capture the exit code
          OUTPUT=$(python scripts/validate_schema_registry.py --check-all --verbose 2>&1)
          EXIT_CODE=$?
          set -e
          
          # Print output
          echo "$OUTPUT"
          
          # Check if registry is missing and output to GITHUB_OUTPUT
          if echo "$OUTPUT" | grep -q "REGISTRY_MISSING"; then
            echo "registry_missing=true" >> $GITHUB_OUTPUT
          else
            echo "registry_missing=false" >> $GITHUB_OUTPUT
          fi
          
          # Exit with the original exit code
          exit $EXIT_CODE
        continue-on-error: false
      
      # Create issue if ATA 91 schema registry is missing
      - name: Create Issue for Missing Schema Registry
        if: always() && steps.schema_registration.outputs.registry_missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'schema-registry-missing',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              console.log('Issue already exists for missing schema registry');
              return;
            }
            
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìã Create ATA 91 Schema Registry',
              body: `## Missing Schema Registry Detected

The CI governance gate (GATE-002) detected that the **ATA 91 schema registry** is missing from this repository.

### Required Action
Create a schema registry CSV file following the ATA 91 schema governance policy.

### Expected Location
The registry should be placed in one of the following locations:
- \`**/schema-registry*.csv\`
- \`**/91_*_TAB_*_schema-registry_*.csv\`
- \`**/schema_registry*.csv\`

### Required Fields
The CSV should include the following columns:
- \`schema_id\`: Unique identifier for the schema
- \`version\`: Schema version
- \`namespace\`: Schema namespace
- \`owner\`: Responsible owner/team
- \`status\`: Current status (active, deprecated, draft, superseded)
- \`file_path\`: Path to the schema file
- \`description\`: Brief description of the schema
- \`content_hash\`: SHA-256 hash of schema content (optional)

### Reference
- **Task**: T2-AI from K06 ATA 00 Tasklist
- **Gate**: GATE-002 (Schema Registration Check)
- **Policy**: CM's schema governance policy

---
*This issue was automatically created by the CI governance gate.*`,
              labels: ['schema-registry-missing', 'governance', 'K06', 'ATA-91']
            });
            
            console.log('Created issue for missing schema registry');
      
      # GATE-003: Trace Link Integrity Check (WARNING)
      # Validates trace link integrity: broken links and staleness detection
      # Consumes: ATA 93 trace semantics + evidence link schema
      - name: GATE-003 - Trace Link Integrity Check
        id: trace_integrity
        run: |
          echo "üîç Validating trace link integrity..."
          set +e  # Don't exit on error
          python scripts/validate_trace_links.py --check-all --no-staleness --verbose --output-json broken-links.json
          EXIT_CODE=$?
          set -e
          
          # Check if broken links file exists and has content
          if [ -f "broken-links.json" ]; then
            BROKEN_COUNT=$(python -c "import json; data=json.load(open('broken-links.json')); print(data.get('total_broken', 0))")
            echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
            echo "has_broken_links=true" >> $GITHUB_OUTPUT
          else
            echo "broken_count=0" >> $GITHUB_OUTPUT
            echo "has_broken_links=false" >> $GITHUB_OUTPUT
          fi
          
          exit $EXIT_CODE
        continue-on-error: true
      
      # Create issue for broken trace links (if any found)
      - name: Create Issue for Broken Trace Links
        if: always() && steps.trace_integrity.outputs.has_broken_links == 'true' && steps.trace_integrity.outputs.broken_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read broken links JSON
            let brokenLinks = [];
            let totalBroken = 0;
            try {
              const data = JSON.parse(fs.readFileSync('broken-links.json', 'utf8'));
              brokenLinks = data.broken_links || [];
              totalBroken = data.total_broken || 0;
            } catch (e) {
              console.log('Could not read broken-links.json:', e.message);
              return;
            }
            
            if (brokenLinks.length === 0) {
              console.log('No broken links to report');
              return;
            }
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'broken-trace-links',
              state: 'open'
            });
            
            if (issues.data.length > 0) {
              console.log('Issue already exists for broken trace links, updating...');
              // Update existing issue with new broken links
              const existingIssue = issues.data[0];
              
              // Build updated body
              let linksTable = '| Source File | Missing Path | Line |\n|---|---|---|\n';
              for (const link of brokenLinks.slice(0, 50)) {  // Limit to 50 links
                linksTable += `| \`${link.source_file}\` | \`${link.target_path}\` | ${link.line_number} |\n`;
              }
              
              if (brokenLinks.length > 50) {
                linksTable += `\n_...and ${brokenLinks.length - 50} more broken links_\n`;
              }
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## üîó Broken Trace Links Detected
            
            The CI governance gate (GATE-003) detected **${totalBroken} broken trace link(s)** in this repository.
            
            ### Broken Links
            
            ${linksTable}
            
            ### Required Action
            Create the missing files at the paths listed above, or fix the references in the source files.
            
            ### Reference
            - **Task**: T3-AI from K06 ATA 00 Tasklist
            - **Gate**: GATE-003 (Trace Link Integrity Check)
            - **Validator**: \`scripts/validate_trace_links.py\`
            
            ---
            *Last updated by CI governance gate on ${new Date().toISOString()}*`
              });
              
              console.log('Updated existing issue #' + existingIssue.number);
              return;
            }
            
            // Build links table for new issue
            let linksTable = '| Source File | Missing Path | Line |\n|---|---|---|\n';
            for (const link of brokenLinks.slice(0, 50)) {  // Limit to 50 links
              linksTable += `| \`${link.source_file}\` | \`${link.target_path}\` | ${link.line_number} |\n`;
            }
            
            if (brokenLinks.length > 50) {
              linksTable += `\n_...and ${brokenLinks.length - 50} more broken links_\n`;
            }
            
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîó Fix Broken Trace Links in Documentation',
              body: `## üîó Broken Trace Links Detected
            
            The CI governance gate (GATE-003) detected **${totalBroken} broken trace link(s)** in this repository.
            
            ### Broken Links
            
            ${linksTable}
            
            ### Required Action
            Create the missing files at the paths listed above, or fix the references in the source files.
            
            ### Reference
            - **Task**: T3-AI from K06 ATA 00 Tasklist
            - **Gate**: GATE-003 (Trace Link Integrity Check)
            - **Validator**: \`scripts/validate_trace_links.py\`
            
            ---
            *This issue was automatically created by the CI governance gate.*`,
              labels: ['broken-trace-links', 'governance', 'K06', 'ATA-93', 'documentation']
            });
            
            console.log('Created new issue for broken trace links');
      
      # GATE-004: Namespace Deduplication Check (BLOCKING - when script exists)
      - name: GATE-004 - Namespace Deduplication Check
        id: namespace_dedup
        run: |
          echo "üîç Checking for duplicate namespace IDs..."
          if [ -f "scripts/check_ata99_registry.py" ]; then
            python scripts/check_ata99_registry.py --deduplicate
          else
            echo "‚ö†Ô∏è  Script not yet implemented (planned)"
          fi
        continue-on-error: true
      
      # GATE-006: Detect Governance Changes (LABELING)
      - name: GATE-006 - Detect Governance Changes
        id: governance_changes
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Detecting governance-impacting changes..."
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }})
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for governance-impacting patterns
          GOVERNANCE_CHANGE=false
          
          # Pattern 1: Standards (STD files in ATA 00)
          if echo "$CHANGED_FILES" | grep -E "00_00_STD_.*\.md$"; then
            echo "‚úì Governance standard change detected"
            GOVERNANCE_CHANGE=true
          fi
          
          # Pattern 2: CI workflows
          if echo "$CHANGED_FILES" | grep -E "\.github/workflows/.*\.yml$"; then
            echo "‚úì CI workflow change detected"
            GOVERNANCE_CHANGE=true
          fi
          
          # Pattern 3: Validation scripts
          if echo "$CHANGED_FILES" | grep -E "validate_.*\.py$|scripts/(check|validate|detect).*\.py$"; then
            echo "‚úì Validation script change detected"
            GOVERNANCE_CHANGE=true
          fi
          
          # Output result
          if [ "$GOVERNANCE_CHANGE" = true ]; then
            echo "governance_change=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Governance change detected - CM WG approval required"
            exit 0
          else
            echo "governance_change=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No governance changes detected"
          fi
      
      # GATE-006: Label PR for Governance Review
      - name: Label PR as Governance Review Required
        if: github.event_name == 'pull_request' && steps.governance_changes.outputs.governance_change == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['governance-review-required']
            });
            
            // Add comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ‚ö†Ô∏è Governance Change Detected (GATE-006)
              
This PR modifies governance-impacting files and requires **CM WG approval** before merge.

### Detected Changes
- Governance standards (STD files)
- CI/CD workflows
- Validation scripts

### Required Actions
1. **Request review** from a CM WG member
2. **Address feedback** from CM WG review
3. **Await approval** before merging

### Reference
- **Policy**: 00_00_STD_LC01_SPACET_governance-reference-policy_v01.md ¬ß6.3
- **Gate**: GATE-006 (Governance Change Detection)
- **Index**: 00_00_IDX_LC01_SPACET_ci-governance-gates_v01.md
              `
            });
      
      # GATE-007: Breaking Schema Changes (BLOCKING - when script exists)
      - name: GATE-007 - Breaking Schema Change Detection
        id: schema_breaking
        run: |
          echo "üîç Detecting breaking schema changes..."
          if [ -f "scripts/detect_schema_breaking_changes.py" ]; then
            python scripts/detect_schema_breaking_changes.py --registry ATA91
          else
            echo "‚ö†Ô∏è  Script not yet implemented (planned)"
          fi
        continue-on-error: true
      
      # GATE-008: Evidence Link Validation (WARNING)
      - name: GATE-008 - Evidence Link Validation
        id: evidence_links
        run: |
          echo "üîç Validating evidence links..."
          if [ -f "scripts/validate_evidence_links.py" ]; then
            python scripts/validate_evidence_links.py --all
          else
            echo "‚ö†Ô∏è  Script not yet implemented (planned)"
          fi
        continue-on-error: true
      
      # Summary Report
      - name: Generate Gate Summary
        if: always()
        run: |
          echo "## üìä Governance Gates Summary"
          echo ""
          echo "| Gate | Status | Description |"
          echo "|------|--------|-------------|"
          echo "| GATE-001 | ${{ steps.nomenclature.outcome == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }} | Nomenclature Validation |"
          echo "| GATE-005 | ‚è≠Ô∏è PLANNED | Identifier Grammar Check |"
          echo "| GATE-002 | ‚è≠Ô∏è PLANNED | Schema Registration Check |"
          echo "| GATE-003 | ${{ steps.trace_integrity.outcome == 'success' && '‚úÖ PASS' || '‚ö†Ô∏è WARNING' }} | Trace Link Integrity |"
          echo "| GATE-004 | ‚è≠Ô∏è PLANNED | Namespace Deduplication |"
          echo "| GATE-006 | ${{ steps.governance_changes.outputs.governance_change == 'true' && '‚ö†Ô∏è REVIEW' || '‚úÖ PASS' }} | Governance Change Detection |"
          echo "| GATE-007 | ‚è≠Ô∏è PLANNED | Breaking Schema Detection |"
          echo "| GATE-008 | ‚è≠Ô∏è PLANNED | Evidence Link Validation |"
          echo ""
          echo "‚úÖ PASS: Gate passed"
          echo "‚ùå FAIL: Gate failed (blocking)"
          echo "‚ö†Ô∏è REVIEW: Manual review required"
          echo "‚ö†Ô∏è WARNING: Issues detected (non-blocking)"
          echo "‚è≠Ô∏è PLANNED: Gate not yet implemented"
